# DNS Failover для Cloudflare

Автоматическая система переключения DNS записей в Cloudflare при недоступности серверов.

## Описание

Это приложение решает проблему недоступности сайта при падении одного из провайдеров интернета. Когда основной сервер становится недоступным, приложение автоматически переключает DNS запись в Cloudflare на резервный IP адрес.

## Возможности

- ✅ Мониторинг доступности серверов (TCP/HTTP проверки)
- ✅ Автоматическое переключение DNS записей через Cloudflare API
- ✅ Настраиваемые приоритеты серверов
- ✅ Подробное логирование всех операций
- ✅ Настраиваемые интервалы проверки и пороги недоступности
- ✅ Поддержка нескольких серверов
- ✅ Тестовый режим для проверки конфигурации

## Установка

1. **Установите Python 3.7 или новее**

2. **Установите зависимости:**
   ```bash
   pip install -r requirements.txt
   ```

3. **Настройте конфигурацию в `config.yaml`:**

   - **Cloudflare API Token:** Создайте токен в [Cloudflare Dashboard](https://dash.cloudflare.com/profile/api-tokens)
     - Перейдите в "My Profile" → "API Tokens" → "Create Token"
     - Используйте шаблон "Custom token"
     - Разрешения: Zone:Read, DNS:Edit
     - Ресурсы: Include - Specific zone - ваш домен

   - **Zone ID:** Найдите в обзоре вашего домена в Cloudflare Dashboard

   - **Настройте IP адреса ваших серверов**

## Конфигурация

Основные параметры в `config.yaml`:

```yaml
cloudflare:
  api_token: "ваш_api_токен_cloudflare"
  zone_id: "ваш_zone_id"
  domain_name: "ваш_домен.com"

servers:
  primary:
    ip: "192.168.1.100"    # IP первого провайдера
    port: 80
    priority: 1            # Наивысший приоритет

  secondary:
    ip: "192.168.1.101"    # IP второго провайдера  
    port: 80
    priority: 2

monitoring:
  check_interval: 60       # Интервал проверки в секундах
  timeout: 10             # Тайм-аут проверки
  failure_threshold: 3    # Количество неудач перед переключением
  check_method: "tcp"     # Метод проверки: "tcp" или "http"
```

## Использование

### Запуск сервиса
```bash
python main.py
```

### Тестирование конфигурации
```bash
python main.py --test
```

### Просмотр текущего статуса
```bash
python main.py --status
```

### Использование альтернативного файла конфигурации
```bash
python main.py --config /path/to/config.yaml
```

## Логирование

Приложение ведет подробные логи:
- Консольный вывод для мониторинга в реальном времени
- Файл `dns_failover.log` для долгосрочного хранения
- Настраиваемый уровень логирования (DEBUG, INFO, WARNING, ERROR)

## Примеры сценариев работы

### Сценарий 1: Нормальная работа
1. Основной сервер (priority: 1) доступен
2. DNS запись указывает на основной IP
3. Периодические проверки подтверждают доступность

### Сценарий 2: Переключение на резерв
1. Основной сервер становится недоступным
2. После 3 неудачных проверок (failure_threshold)
3. DNS автоматически переключается на резервный IP
4. Логируется событие переключения

### Сценарий 3: Восстановление основного сервера
1. Основной сервер снова становится доступным
2. Система автоматически переключается обратно (по приоритету)
3. DNS возвращается на основной IP

## Безопасность

- API токен Cloudflare храните в безопасности
- Используйте минимальные необходимые разрешения для токена
- Регулярно проверяйте логи на предмет подозрительной активности

## Troubleshooting

### Проблема: "DNS запись не найдена"
- Убедитесь, что домен существует в указанной зоне Cloudflare
- Проверьте правильность zone_id и domain_name

### Проблема: "Ошибка авторизации API"
- Проверьте корректность API токена
- Убедитесь, что токен имеет необходимые разрешения

### Проблема: "Серверы недоступны"
- Проверьте настройки файрвола
- Убедитесь, что указанные порты открыты
- Попробуйте изменить check_method с "tcp" на "http"

## Мониторинг производительности

Приложение выводит статус каждые 5 минут:
```
DNS Failover Status - 2024-10-02T15:30:00
============================================================
Активный сервер: primary

Статус серверов:
  ✅ primary [АКТИВНЫЙ]
     IP: 192.168.1.100:80
     Приоритет: 1
     Ошибок подряд: 0

  ✅ secondary
     IP: 192.168.1.101:80
     Приоритет: 2
     Ошибок подряд: 0
============================================================
```

## Автозапуск

### Windows (Task Scheduler)
1. Откройте "Планировщик заданий"
2. Создайте новое задание
3. Укажите команду: `python C:\path\to\main.py`
4. Настройте запуск при старте системы

### Linux (systemd)
Создайте файл `/etc/systemd/system/dns-failover.service`:
```ini
[Unit]
Description=DNS Failover Service
After=network.target

[Service]
Type=simple
User=your-user
WorkingDirectory=/path/to/dns-api
ExecStart=/usr/bin/python3 /path/to/dns-api/main.py
Restart=always

[Install]
WantedBy=multi-user.target
```

Активируйте сервис:
```bash
sudo systemctl enable dns-failover.service
sudo systemctl start dns-failover.service
```